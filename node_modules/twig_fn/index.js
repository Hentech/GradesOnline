module.exports = function(Twig) {
    Twig.exports.extendTag({
        // unique name for tag type
        type: "fn",
        // regex for matching tag
        regex: /^fn\s+(.+)$/,

        // what type of tags can follow this one.
        next: ["endfn"], // match the type of the end tag
        open: true,
        compile: function (token) {
            var expression = token.match[1];

            // turn the string expression into tokens.
            token.stack = Twig.expression.compile.apply(this, [{
                type:  Twig.expression.type.expression,
                value: expression
            }]).stack;

            delete token.match; // cleanup
            return token;
        },
        parse: function (token, context, chain) {

            var tag = this;
            Twig.exports.extendFunction(token.stack[0].value, function(args){
            	for(var key in args) context[key] = args[key];
            	return Twig.parse.apply(tag, [token.output, context]);
            });
            return {
                chain: chain,
                output: ''
            };
        }
    });

    // a matching end tag type
    Twig.exports.extendTag({
        type: "endfn",
        regex: /^endfn$/,
        next: [ ],
        open: false
    });
};